name: ModernTribe - Create Review App
description: Create Review App in Dokku Server
author: moderntribe
inputs:
    app_name:
      required: true
      description: Dokku Original App Name
    review_app_name:
      required: true
      description: Dokku Review App Name
    server:
      required: true
      description: Server Name
    ssh_private_key:
      required: true
      description: SSH Private Key
    github_pat_token:
      required: true
      description: Github Personal Access token
    gha_url:
      required: true
      description: Github Actions Run URL
runs:
  using: composite
  steps:
      - name: Write SSH keys
        shell: bash
        run: |
          install -m 600 -D /dev/null ~/.ssh/id_rsa
          echo "${{ inputs.ssh_private_key }}" > ~/.ssh/id_rsa
          ssh-keyscan -H ${{ inputs.server }} > ~/.ssh/known_hosts

      - name: Check if ${{ inputs.review_app_name }} already exists
        id: test_app
        shell: bash
        run: |
          output=$(ssh -i ~/.ssh/id_rsa dokku@${{ inputs.server }} apps:exists ${{ inputs.review_app_name }} 2>&1 || true)

          if [[ "$output" =~ "does not exist" ]] ; then
            echo "Matched. App does not exists."
            echo ::set-output name=app_exists::"false"
          else
            echo "App already exists. Skipping creation..."
            echo ::set-output name=app_exists::"true"
          fi

      - name: Repository Dispatch | Launch ${{ inputs.review_app_name }}
        if: steps.test_app.outputs.app_exists == 'false'
        uses: peter-evans/repository-dispatch@v1
        with:
          repository: moderntribe/dokku-ansible
          event-type: create-review-app
          token: "${{ inputs.github_pat_token }}"
          client-payload: |
            {
              "review_app_name": "${{ inputs.review_app_name }}",
              "app_name": "${{ inputs.app_name }}",
              "server": "${{ inputs.server }}",
              "action_url": "${{ inputs.gha_url }}"
            }